require "progressbar"

require_relative "storage"
storage = Storage.new

require "yaml"
require "goodreads"

config = YAML.load(File.read("#{__dir__}/config.yml"))["goodreads"]
fail("Goodreads API credentials must be configured in config.yml") unless config["key"] && config["secret"]
goodreads = Goodreads::Client.new(api_key: config["key"], api_secret: config["secret"])

# https://www.goodreads.com/choiceawards/best-books-2019
books = {
  "Fiction" => [
    42975172, 41057294, 40545956, 42201996, 40539165, 41880609, 34313931, 41723456, 43984883, 41880044, 42431386,
    40390714, 43697186, 39863464, 42207168, 41880602, 44581535, 42976592, 41940306,
  ],
  "Mystery & Thriller" => [
    40097951, 38819868, 42080142, 39863488, 39863515, 41940236, 40697540, 42368604, 40121959, 39863405, 44034500,
    43822820, 42779092, 34563821, 41716679, 41081925, 43885041, 42599605, 39796904, 38355304,
  ],
  "Historical Fiction" => [
    40597810, 42279228, 40390766, 42135029, 43925876, 43982054, 40130093, 41556734, 44318414, 42283286, 40538657,
    40546098, 39863482, 40988979, 42589678, 45033931, 42366224, 25813942, 41555942, 41454042,
  ],
  "Fantasy" => [
    43263680, 43575115, 39943621, 40381319, 35297403, 36906346, 37638128, 40524748, 40524312, 41893832, 43521657,
    36510722, 39855052, 41212753, 37587820, 41555947, 30169100, 42592353, 35606041, 38099642,
  ],
  "Romance" => [
    52410331, 41150382, 39338454, 42101728, 41450662, 41150287, 39709060, 36117813, 42785825, 42599067, 41063454,
    43205122, 43603066, 43616063, 42079209,
  ],
  "Science Fiction" => [
    42046112, 37678631, 42036538, 41093489, 42201962, 28335698, 42260978, 41940388, 41824495, 42036965, 43190272,
    34019083, 37534907, 39863238, 43160651, 43263237, 39217756, 41716930, 40523931,
  ],
  "Horror" => [
    43798285, 43522576, 42881101, 40065317, 44034616, 43801817, 42815544, 40725252, 42527596, 43506916, 43706714,
    42118050, 41888678, 41555927, 44349541, 44791629, 43263515, 40696751, 42201850, 42186023,
  ],
  "Humor" => [
    44600621, 43885930, 42060068, 43263670, 40983137, 41188319, 41429806, 42506471, 43908975, 43615787, 41940280,
    44527315, 34315901, 40819522, 44908180, 43309518, 44064563, 42046110,
  ],
  "Nonfiction" => [
    40591267, 41066983, 37570546, 53011908, 40574441, 42201100, 43231095, 44767249, 40776644, 38362811, 41154327,
    43822665, 40121993, 43126457, 41883932, 44767265, 40265832, 40365093, 36742978,
  ],
  "Memoir & Autobiography" => [
    43386674, 46264398, 44286431, 39218350, 44303730, 40364332, 45167624, 42202117, 43682552, 43263491, 44776548,
    42188604, 46223297, 42729452, 40046084, 43497893, 40180065, 39216478, 43261166,
  ],
  "History & Biography" => [
    37570548, 40538681, 40163119, 44908411, 40595446, 43821991, 42201377, 40594422, 39863169, 41796203, 40121985,
    41219594, 40165912, 40539126, 41716904, 41812830, 40360266, 40121946, 42972023,
  ],
  "Science & Technology" => [
    43785830, 41104077, 43582376, 43852758, 40180060, 40405444, 41552709, 41817481, 44526650, 43565381, 39999461,
    40597264, 44595007, 42397849, 36739320, 43723901, 36589701, 44573628, 44065062, 40696923,
  ],
  "Food & Cookbooks" => [
    39977443, 43884186, 40645634, 44429515, 41948849, 42583941, 41644326, 40796136, 41155069, 46131607, 39858047,
    40180121, 40796103, 43261151, 37805223, 40864247, 40916358,
  ],
  "Graphic Novels & Comics" => [
    40864790, 43307358, 40766383, 42527866, 39296114, 38452813, 38524301, 21801668, 44774415, 38812893, 39073378,
    39073387, 40864841, 36700347, 41391399, 41812788, 45899240, 40538764, 42835876, 42667807,
  ],
  "Poetry" => [
    40519259, 40680973, 43838654, 39656141, 44157727, 41219132, 40046136, 43453732, 40680971, 43124132, 40611194,
    43822523, 41746324, 40121980, 41745412, 40909463, 44313592, 43726619,
  ],
  "Debut Novel" => [
    41150487, 40097951, 38819868, 43521657, 43982054, 40514431, 41880609, 34313931, 43426115, 40539165, 40024139,
    40121959, 41880044, 40696776, 39863464, 39679076, 36492488, 42036538, 42785825, 41880602,
  ],
  "Young Adult Fiction" => [
    38926328, 35887567, 41154268, 38225791, 43220998, 41147279, 41473872, 39893545, 43744300, 42245770, 37539001,
    40695682, 39725622, 39847584, 36511805, 40536335, 43263520, 44107480, 40148146, 39863399,
  ],
  "Young Adult Fantasy & Science Fiction" => [
    38237340, 44017627, 36538785, 39804936, 42505366, 43822024, 43204703, 40381392, 42201395, 30075662, 42771754,
    34992959, 39863277, 31373184, 40367270, 42121526, 44139418, 40024139, 36492488, 39863498,
  ],
  "Middle Grade & Children's" => [
    43128231, 43319657, 42097227, 39280558, 39893619, 40139216, 34966859, 43120234, 40390757, 41067826, 40206380,
    41154293, 43822791, 41429527, 38609428, 43231099, 39855034, 44023770, 43453642, 39884337,
  ],
  "Picture Books" => [
    42616620, 42785750, 40221498, 40944115, 38595349, 42931503, 38791999, 41451728, 43671848, 41183554, 41954472,
    43853210, 32335532, 40607588, 42642044, 41954471, 41451729, 40796177, 41954470, 43662690,
  ],
}

books.each_with_index do |(category, ids), idx|
  progress = ProgressBar.create(
    :format => "[#{idx + 1}/#{books.size}] %t %b>%i %p%% %e",
    :title => category,
    :total => ids.size,
  )
  ids.each do |id|
    book = goodreads.book(id)
    book.id = "book#{id}"
    book.category = category
    book.description = book.description
      .gsub(/(<br\s*\/?>\s*)+/, "<p>")
    book.delete("reviews_widget")
    storage.add_book(book)
    progress.increment
  end
end

